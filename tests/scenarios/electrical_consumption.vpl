# Electrical Consumption Monitoring
# Site with multiple buildings, each with multiple floors
# Detects abnormal consumption and aggregates by site/building

# =============================================================================
# User-Defined Functions
# =============================================================================

# Calculate threshold for abnormal consumption (150% of baseline)
fn abnormal_threshold(baseline: float) -> float:
    baseline * 1.5

# Check if consumption is abnormally high
fn is_abnormal(consumption: float, baseline: float) -> bool:
    consumption > abnormal_threshold(baseline)

# Calculate percentage over baseline
fn percent_over_baseline(consumption: float, baseline: float) -> float:
    (consumption - baseline) / baseline * 100.0

# Consumption severity level
fn get_severity(consumption: float, baseline: float) -> str:
    "warning"

# =============================================================================
# Event Declarations
# =============================================================================

event FloorConsumption:
    site_id: str
    building_id: str
    floor_id: str
    consumption_kwh: float
    baseline_kwh: float
    ts: int

# =============================================================================
# Main Streams
# =============================================================================

# Stream 1: Detect abnormal floor consumption
stream AbnormalFloorConsumption = FloorConsumption as fc
    .print("Floor reading:", site_id, building_id, floor_id, "=", consumption_kwh, "kWh")
    .log(level: "debug", message: "Processing floor consumption")
    .where(is_abnormal(consumption_kwh, baseline_kwh))
    .print("ALERT: Abnormal consumption at", site_id, building_id, floor_id)
    .log(level: "warn", message: "Abnormal consumption detected")
    .emit(
        alert_type: "abnormal_consumption",
        site_id: fc.site_id,
        building_id: fc.building_id,
        floor_id: fc.floor_id,
        consumption: fc.consumption_kwh,
        baseline: fc.baseline_kwh,
        percent_over: percent_over_baseline(fc.consumption_kwh, fc.baseline_kwh),
        severity: get_severity(fc.consumption_kwh, fc.baseline_kwh)
    )

# Stream 2: Aggregate consumption by building (5-minute window)
stream BuildingConsumption = FloorConsumption
    .window(5m)
    .partition_by(building_id)
    .aggregate(
        total_consumption: sum(consumption_kwh),
        total_baseline: sum(baseline_kwh),
        floor_count: count(floor_id),
        max_consumption: max(consumption_kwh),
        avg_consumption: avg(consumption_kwh)
    )
    .print("Building total:", building_id, "=", total_consumption, "kWh")
    .log(level: "info", message: "Building consumption aggregated")
    .emit(
        report_type: "building_summary",
        building_id: building_id,
        total_consumption: total_consumption,
        total_baseline: total_baseline,
        floor_count: floor_count,
        max_floor_consumption: max_consumption,
        avg_floor_consumption: avg_consumption
    )

# Stream 3: Aggregate consumption by site (5-minute window)
stream SiteConsumption = FloorConsumption
    .window(5m)
    .partition_by(site_id)
    .aggregate(
        total_consumption: sum(consumption_kwh),
        total_baseline: sum(baseline_kwh),
        reading_count: count(floor_id)
    )
    .print("Site total:", site_id, "=", total_consumption, "kWh")
    .log(level: "info", message: "Site consumption aggregated")
    .emit(
        report_type: "site_summary",
        site_id: site_id,
        total_consumption: total_consumption,
        total_baseline: total_baseline,
        reading_count: reading_count
    )

# Stream 4: Detect building-level anomalies (building total over threshold)
stream BuildingAnomaly = FloorConsumption
    .window(5m)
    .partition_by(building_id)
    .aggregate(
        total: sum(consumption_kwh),
        baseline_total: sum(baseline_kwh)
    )
    .where(total > baseline_total * 1.3)
    .print("ALERT: Building anomaly at", building_id, "total:", total, "kWh")
    .log(level: "error", message: "Building-level anomaly detected")
    .emit(
        alert_type: "building_anomaly",
        building_id: building_id,
        total_consumption: total,
        baseline_total: baseline_total,
        severity: "critical"
    )

# Stream 5: Track consumption trends (detect sudden spikes)
stream ConsumptionSpike = FloorConsumption as current
    -> FloorConsumption where floor_id == current.floor_id as next
    .within(10m)
    .where(next.consumption_kwh > current.consumption_kwh * 2.0)
    .print("SPIKE detected:", floor_id)
    .log(level: "error", message: "Consumption spike detected")
    .emit(
        alert_type: "consumption_spike",
        floor_id: current.floor_id,
        previous: current.consumption_kwh,
        spike: next.consumption_kwh
    )
