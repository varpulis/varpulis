# Varpulis Demo - Full Stack (HA Cluster)
#
# Public demo at https://demo.varpulis-cep.com
# Only Caddy exposes ports 80/443 to the host.
#
# Architecture:
#   3 coordinators (Raft consensus + RocksDB persistence)
#   4 workers (split across coordinators)
#   Caddy load-balances API across all coordinators
#
# Usage:
#   docker compose build
#   docker compose up -d

services:
  # ─── Reverse Proxy (TLS termination + load balancing) ────
  caddy:
    image: caddy:2-alpine
    container_name: demo-caddy
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - /etc/caddy/certs:/etc/caddy/certs:ro
      - caddy-data:/data
      - caddy-config:/config
    depends_on:
      web-ui:
        condition: service_healthy
      coordinator-1:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - varpulis-demo

  # ─── Web UI (Vue SPA + Nginx) ─────────────────────────────
  web-ui:
    build:
      context: ../../web-ui
      dockerfile: Dockerfile
      args:
        VITE_API_KEY: "${VARPULIS_API_KEY}"
    container_name: demo-web-ui
    expose:
      - "8080"
    depends_on:
      coordinator-1:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    networks:
      - varpulis-demo

  # ─── Coordinator 1 (Raft node 1) ──────────────────────────
  coordinator-1:
    build:
      context: ../..
      dockerfile: deploy/docker/Dockerfile
      args:
        FEATURES: "kafka,raft,persistent"
    container_name: demo-coordinator-1
    command:
      - "coordinator"
      - "--bind"
      - "0.0.0.0"
      - "--port"
      - "9100"
      - "--api-key"
      - "${VARPULIS_API_KEY}"
      - "--raft"
      - "--raft-node-id"
      - "1"
      - "--raft-peers"
      - "http://coordinator-1:9100,http://coordinator-2:9100,http://coordinator-3:9100"
      - "--raft-data-dir"
      - "/app/state"
    expose:
      - "9100"
    environment:
      - RUST_LOG=${RUST_LOG:-info}
      - VARPULIS_LLM_ENDPOINT=${VARPULIS_LLM_ENDPOINT:-http://ollama:11434/v1}
      - VARPULIS_LLM_MODEL=${VARPULIS_LLM_MODEL:-qwen2.5:7b}
      - VARPULIS_LLM_API_KEY=${VARPULIS_LLM_API_KEY:-}
      - VARPULIS_LLM_PROVIDER=${VARPULIS_LLM_PROVIDER:-openai-compatible}
      - VARPULIS_S3_ENDPOINT=http://minio:9000
      - VARPULIS_S3_BUCKET=varpulis-models
    volumes:
      - coord1-data:/app/state
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9100/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    restart: unless-stopped
    networks:
      - varpulis-demo

  # ─── Coordinator 2 (Raft node 2) ──────────────────────────
  coordinator-2:
    build:
      context: ../..
      dockerfile: deploy/docker/Dockerfile
      args:
        FEATURES: "kafka,raft,persistent"
    container_name: demo-coordinator-2
    command:
      - "coordinator"
      - "--bind"
      - "0.0.0.0"
      - "--port"
      - "9100"
      - "--api-key"
      - "${VARPULIS_API_KEY}"
      - "--raft"
      - "--raft-node-id"
      - "2"
      - "--raft-peers"
      - "http://coordinator-1:9100,http://coordinator-2:9100,http://coordinator-3:9100"
      - "--raft-data-dir"
      - "/app/state"
    expose:
      - "9100"
    environment:
      - RUST_LOG=${RUST_LOG:-info}
      - VARPULIS_LLM_ENDPOINT=${VARPULIS_LLM_ENDPOINT:-http://ollama:11434/v1}
      - VARPULIS_LLM_MODEL=${VARPULIS_LLM_MODEL:-qwen2.5:7b}
      - VARPULIS_LLM_API_KEY=${VARPULIS_LLM_API_KEY:-}
      - VARPULIS_LLM_PROVIDER=${VARPULIS_LLM_PROVIDER:-openai-compatible}
      - VARPULIS_S3_ENDPOINT=http://minio:9000
      - VARPULIS_S3_BUCKET=varpulis-models
    volumes:
      - coord2-data:/app/state
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9100/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    restart: unless-stopped
    networks:
      - varpulis-demo

  # ─── Coordinator 3 (Raft node 3) ──────────────────────────
  coordinator-3:
    build:
      context: ../..
      dockerfile: deploy/docker/Dockerfile
      args:
        FEATURES: "kafka,raft,persistent"
    container_name: demo-coordinator-3
    command:
      - "coordinator"
      - "--bind"
      - "0.0.0.0"
      - "--port"
      - "9100"
      - "--api-key"
      - "${VARPULIS_API_KEY}"
      - "--raft"
      - "--raft-node-id"
      - "3"
      - "--raft-peers"
      - "http://coordinator-1:9100,http://coordinator-2:9100,http://coordinator-3:9100"
      - "--raft-data-dir"
      - "/app/state"
    expose:
      - "9100"
    environment:
      - RUST_LOG=${RUST_LOG:-info}
      - VARPULIS_LLM_ENDPOINT=${VARPULIS_LLM_ENDPOINT:-http://ollama:11434/v1}
      - VARPULIS_LLM_MODEL=${VARPULIS_LLM_MODEL:-qwen2.5:7b}
      - VARPULIS_LLM_API_KEY=${VARPULIS_LLM_API_KEY:-}
      - VARPULIS_LLM_PROVIDER=${VARPULIS_LLM_PROVIDER:-openai-compatible}
      - VARPULIS_S3_ENDPOINT=http://minio:9000
      - VARPULIS_S3_BUCKET=varpulis-models
    volumes:
      - coord3-data:/app/state
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9100/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    restart: unless-stopped
    networks:
      - varpulis-demo

  # ─── Worker 0 (coordinator-1) ───────────────────────────────
  worker-0:
    build:
      context: ../..
      dockerfile: deploy/docker/Dockerfile
      args:
        FEATURES: kafka
    container_name: demo-worker-0
    command:
      - "server"
      - "--bind"
      - "0.0.0.0"
      - "--port"
      - "9000"
      - "--api-key"
      - "${VARPULIS_WORKER_KEY}"
      - "--metrics"
      - "--coordinator"
      - "http://coordinator-1:9100"
      - "--worker-id"
      - "worker-0"
      - "--advertise-address"
      - "http://worker-0:9000"
    expose:
      - "9000"
      - "9090"
    environment:
      - RUST_LOG=${RUST_LOG:-info}
      - VARPULIS_WORKER_ID=worker-0
    depends_on:
      coordinator-1:
        condition: service_healthy
      mosquitto:
        condition: service_started
      kafka:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - varpulis-demo

  # ─── Worker 1 (coordinator-1) ───────────────────────────────
  worker-1:
    build:
      context: ../..
      dockerfile: deploy/docker/Dockerfile
      args:
        FEATURES: kafka
    container_name: demo-worker-1
    command:
      - "server"
      - "--bind"
      - "0.0.0.0"
      - "--port"
      - "9000"
      - "--api-key"
      - "${VARPULIS_WORKER_KEY}"
      - "--metrics"
      - "--coordinator"
      - "http://coordinator-1:9100"
      - "--worker-id"
      - "worker-1"
      - "--advertise-address"
      - "http://worker-1:9000"
    expose:
      - "9000"
      - "9090"
    environment:
      - RUST_LOG=${RUST_LOG:-info}
      - VARPULIS_WORKER_ID=worker-1
    depends_on:
      coordinator-1:
        condition: service_healthy
      mosquitto:
        condition: service_started
      kafka:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - varpulis-demo

  # ─── Worker 2 (coordinator-2) ───────────────────────────────
  worker-2:
    build:
      context: ../..
      dockerfile: deploy/docker/Dockerfile
      args:
        FEATURES: kafka
    container_name: demo-worker-2
    command:
      - "server"
      - "--bind"
      - "0.0.0.0"
      - "--port"
      - "9000"
      - "--api-key"
      - "${VARPULIS_WORKER_KEY}"
      - "--metrics"
      - "--coordinator"
      - "http://coordinator-2:9100"
      - "--worker-id"
      - "worker-2"
      - "--advertise-address"
      - "http://worker-2:9000"
    expose:
      - "9000"
      - "9090"
    environment:
      - RUST_LOG=${RUST_LOG:-info}
      - VARPULIS_WORKER_ID=worker-2
    depends_on:
      coordinator-2:
        condition: service_healthy
      mosquitto:
        condition: service_started
      kafka:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - varpulis-demo

  # ─── Worker 3 (coordinator-3) ───────────────────────────────
  worker-3:
    build:
      context: ../..
      dockerfile: deploy/docker/Dockerfile
      args:
        FEATURES: kafka
    container_name: demo-worker-3
    command:
      - "server"
      - "--bind"
      - "0.0.0.0"
      - "--port"
      - "9000"
      - "--api-key"
      - "${VARPULIS_WORKER_KEY}"
      - "--metrics"
      - "--coordinator"
      - "http://coordinator-3:9100"
      - "--worker-id"
      - "worker-3"
      - "--advertise-address"
      - "http://worker-3:9000"
    expose:
      - "9000"
      - "9090"
    environment:
      - RUST_LOG=${RUST_LOG:-info}
      - VARPULIS_WORKER_ID=worker-3
    depends_on:
      coordinator-3:
        condition: service_healthy
      mosquitto:
        condition: service_started
      kafka:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - varpulis-demo

  # ─── MinIO (S3-compatible model storage) ────────────────────
  minio:
    image: minio/minio:latest
    container_name: demo-minio
    command: server /data --console-address ":9001"
    expose:
      - "9000"
      - "9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_USER:-varpulis}
      MINIO_ROOT_PASSWORD: ${MINIO_PASSWORD:-change-me}
    volumes:
      - minio-data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - varpulis-demo

  # ─── Ollama (local LLM for AI chat) ───────────────────────
  ollama:
    image: ollama/ollama:latest
    container_name: demo-ollama
    expose:
      - "11434"
    volumes:
      - ollama-data:/root/.ollama
    healthcheck:
      test: ["CMD", "ollama", "list"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    networks:
      - varpulis-demo

  # ─── Ollama Setup (one-shot: pull model) ───────────────────
  ollama-setup:
    image: curlimages/curl:latest
    container_name: demo-ollama-setup
    entrypoint: ["sh", "-c", "curl -sf http://ollama:11434/api/pull -d '{\"name\": \"qwen2.5:7b\"}' || true"]
    depends_on:
      ollama:
        condition: service_healthy
    restart: "no"
    networks:
      - varpulis-demo

  # ─── MQTT Broker (market data ingest) ─────────────────────
  mosquitto:
    image: eclipse-mosquitto:2
    container_name: demo-mosquitto
    expose:
      - "1883"
    command: ["mosquitto", "-c", "/mosquitto-no-auth.conf"]
    restart: unless-stopped
    networks:
      - varpulis-demo

  # ─── Zookeeper (Kafka dependency) ─────────────────────────
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: demo-zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 2181 || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - varpulis-demo

  # ─── Kafka (output signal topics) ─────────────────────────
  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: demo-kafka
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: INTERNAL:PLAINTEXT
      KAFKA_LISTENERS: INTERNAL://0.0.0.0:9092
      KAFKA_ADVERTISED_LISTENERS: INTERNAL://kafka:9092
      KAFKA_INTER_BROKER_LISTENER_NAME: INTERNAL
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
    depends_on:
      zookeeper:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "kafka-topics --bootstrap-server localhost:9092 --list || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 30s
    restart: unless-stopped
    networks:
      - varpulis-demo

  # ─── Setup (one-shot: create connectors + deploy pipeline) ─
  setup:
    image: python:3.12-slim
    container_name: demo-setup
    command: ["bash", "-c", "pip install --quiet requests && python /app/setup.py --coordinator http://coordinator-1:9100 --api-key ${VARPULIS_API_KEY} --mqtt-host mosquitto --mqtt-port 1883 --kafka-brokers kafka:9092"]
    volumes:
      - ../../demos/e2e-showcase/setup.py:/app/setup.py:ro
      - ../../demos/e2e-showcase/pipeline.vpl:/app/pipeline.vpl:ro
    depends_on:
      coordinator-1:
        condition: service_healthy
      kafka:
        condition: service_healthy
    restart: "no"
    networks:
      - varpulis-demo

  # ─── Generator (continuous market event stream) ────────────
  generator:
    image: python:3.12-slim
    container_name: demo-generator
    command: >
      bash -c "pip install --quiet paho-mqtt &&
      python /app/generator.py --broker mosquitto --port 1883 --rate 10 --duration 0"
    volumes:
      - ../../demos/e2e-showcase/generator.py:/app/generator.py:ro
    depends_on:
      setup:
        condition: service_completed_successfully
    restart: unless-stopped
    networks:
      - varpulis-demo

  # ─── Prometheus (metrics collection) ───────────────────────
  prometheus:
    image: prom/prometheus:v2.51.0
    container_name: demo-prometheus
    expose:
      - "9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.retention.time=30d"
      - "--web.enable-lifecycle"
    restart: unless-stopped
    networks:
      - varpulis-demo

  # ─── Grafana (monitoring dashboard) ────────────────────────
  grafana:
    image: grafana/grafana:10.4.0
    container_name: demo-grafana
    expose:
      - "3000"
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-varpulis}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_ROOT_URL=https://demo.varpulis-cep.com/grafana/
      - GF_SERVER_SERVE_FROM_SUB_PATH=true
    volumes:
      - grafana-data:/var/lib/grafana
      - ../docker/grafana/provisioning:/etc/grafana/provisioning:ro
      - ../docker/grafana/dashboards:/var/lib/grafana/dashboards:ro
    restart: unless-stopped
    networks:
      - varpulis-demo

volumes:
  caddy-data:
  caddy-config:
  coord1-data:
  coord2-data:
  coord3-data:
  minio-data:
  ollama-data:
  prometheus-data:
  grafana-data:

networks:
  varpulis-demo:
    driver: bridge
